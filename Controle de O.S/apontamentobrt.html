<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manutenção BRT — Ordem de Serviço</title>
  <link href="styleapontamento.css" rel="stylesheet" />
</head>
<body>
  <header>
    <div class="branding">
      <div class="logo">B</div>
      <div>
        <div class="title">Manutenção BRT — Ordem de Serviço</div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="layout">
      <main class="stack">
        <!-- PAINEL 1: OS -->
        <section class="card" aria-labelledby="h-os">
          <h2 id="h-os">Registro da O.S</h2>
          <p class="help">Dados de abertura e fechamento da ocorrência.</p>
          <div class="grid">
            <div class="col-3">
              <label class="req" for="num_os">Número da O.S</label>
              <input id="num_os" type="text" placeholder="" required />
            </div>
            <div class="col-3">
              <label class="req" for="dt_solic">Data/Hora da Solicitação</label> <!-- Esse campo terá que vir automatico da S.S, já ficar bloqueado-->
              <input id="dt_solic" type="datetime-local" required />
            </div>
            <div class="col-3">
              <label class="req" for="dt_abertura">Data/Hora de Abertura - O.S </label>
              <input id="dt_abertura" type="datetime-local" required />
            </div>
            <div class="col-3">
              <label for="dt_fechamento">Data/Hora de Fechamento - O.S</label>
              <input id="dt_fechamento" type="datetime-local" />
            </div>
          </div>
        </section>

        <!-- PAINEL 2: VEÍCULO & CLIENTE -->
        <section class="card" aria-labelledby="h-veic">
          <h2 id="h-veic">Informações do Veículo</h2>
          <p class="help">Identificação do veículo</p>
          <div class="grid">
            <div class="col-3">
              <label class="req" for="placa">Prefixo</label>
              <input id="placa" type="text" placeholder="" required />
            </div>
            <div class="col-3">
              <label class="req" for="placa">Placa</label>
              <input id="placa" type="text" placeholder="" required /> <!-- Campo automatico - Cadastro do Veículo-->
            </div>
            <div class="col-3">
              <label for="modelo">Modelo</label>
              <input id="modelo" type="text" placeholder="Marcopolo/VW 17.230" /> <!--Campo automatico - Cadastro do Veículo -->
            </div>
            <div class="col-3">
              <label for="situacao">Situação do Bem</label>
              <input id="situacao" type="text" placeholder="" /><!--Campo automatico - Cadastro do Veículo -->
            </div>
            <div class="col-3">
              <label for="contrato">Número do Contrato</label>
              <input id="contrato" type="text" placeholder="" /><!--Campo automatico - Cadastro do Veículo -->
            </div>
            <div class="col-6">
              <label for="cliente">Cliente</label>
              <input id="cliente" type="text" placeholder="Consórcio BRT / Prefeitura" /><!--Campo automatico - Cadastro do Veículo -->
            </div>
            <div class="col-3">
              <label for="km">Km do Veículo</label>
              <input id="km" type="number" min="0" step="1" placeholder="152340" />
            </div>
          </div>
        </section>

        <!-- PAINEL 3: DIAGNÓSTICO & TIPO -->
        <section class="card" aria-labelledby="h-diag">
          <h2 id="h-diag">Diagnóstico Relatado</h2>
          <p class="help">Descreva o sintoma e o escopo do atendimento.</p>
          <div class="grid">
            <div class="col-8">
              <label class="req" for="defeito">Defeito Relatado</label>
              <textarea id="defeito" placeholder="Descreva sintomas, códigos de falha, condições de ocorrência..."></textarea>
            </div>
            <div class="col-4">
              <label class="req" for="tipo_servico">Tipo de Serviço</label>
              <select id="tipo_servico">
                <option value="corretiva">Corretiva</option>
                <option value="preventiva">Preventiva</option>
                <option value="preditiva">Preditiva</option>
                <option value="garantia">Garantia</option>
                <option value="campanha">Campanha/Recall</option>
              </select>
            </div>
          </div>
        </section>

        <!-- PAINEL 4: ORÇAMENTOS -->
        <section class="card" aria-labelledby="h-orc">
          <h2 id="h-orc">Anexo de Documentos</h2>
          <p class="help">Anexe no mínimo três orçamentos. Caso a escolha não seja o menor preço, justifique.</p>
          <div class="grid">
            <div class="col-6">
              <div class="files">
                <label class="req">Anexos (mínimo 3) — PDF/Imagem/Excel</label>
                <input id="orc1" type="file" accept=".pdf,.png,.jpg,.jpeg,.xls,.xlsx" />
                <div class="divider"></div>
                <input id="orc2" type="file" accept=".pdf,.png,.jpg,.jpeg,.xls,.xlsx" />
                <div class="divider"></div>
                <input id="orc3" type="file" accept=".pdf,.png,.jpg,.jpeg,.xls,.xlsx" />
                <div class="divider"></div>
                <input id="orc_extra" type="file" multiple accept=".pdf,.png,.jpg,.jpeg,.xls,.xlsx" />
              </div>
            </div>
            <div class="col-6">
              <label class="req" for="menor_preco">Menor Preço?</label>
              <select id="menor_preco">
                <option value="sim">SIM</option>
                <option value="nao">NÃO</option>
              </select>
              <div id="blk_just" class="hidden" style="margin-top:12px">
                <label class="req" for="justificativa">Justificativa (quando NÃO)</label>
                <textarea id="justificativa" placeholder="Motivo..."></textarea>
              </div>
              <div id="warn_orc" class="alert hidden" style="margin-top:12px">É necessário anexar pelo menos <b>3</b> orçamentos antes de salvar.</div>
            </div>
          </div>
        </section>

        <!-- PAINEL 5: ENCAMINHAMENTO -->
        <section class="card" aria-labelledby="h-enc">
          <h2 id="h-enc">Encaminhamentos</h2>
          <p class="help">Dados da ordem de serviço encaminhada/execução externa.</p>
          <div class="grid">
            <div class="col-3">
              <label for="num_enc">Número do Encaminhamento</label>
              <input id="num_enc" type="text" placeholder="" />
            </div>
            <div class="col-3">
              <label class="req" for="oficina_ext">Oficina Externa?</label>
              <select id="oficina_ext">
                <option value="nao">NÃO</option>
                <option value="sim">SIM</option>
              </select>
            </div>
            <div class="col-3">
              <label for="codigo_prod"></label>
              <input id="codigo_prod" type="text" placeholder="PROD-045 / EXT-778" />
            </div>
            <div class="col-3">
              <label for="dt_enc">Data / Hora</label>
              <input id="dt_enc" type="datetime-local" />
            </div>
            <div class="col-12">
              <label for="desc_serv">Descrição do Serviço</label>
              <textarea id="desc_serv" placeholder="Detalhe o serviço encaminhado ou executado"></textarea>
            </div>
            <div class="col-6">
              <label id="lab_danf" for="danf">Anexar DANF da Nota Fiscal</label>
              <input id="danf" type="file" accept=".pdf,.png,.jpg,.jpeg" />
            </div>
          </div>
        </section>

        <!-- PAINEL 6: PEÇAS & MÃO DE OBRA -->
        <section class="card" aria-labelledby="h-mdo">
          <h2 id="h-mdo">Peças & Produtivo (Hora Homem)</h2>
          <p class="help">Informe materiais, equipe e valores.</p>
          <div class="grid">
            <div class="col-4">
              <label class="req" for="pecas">Código do Produto</label>
              <input id="pecas" type="text" placeholder="" required /> <!-- Campo automatico - Cadastro de Produtos-->
            </div>
            <div class="col-4">
              <label class="req" for="desc_pecas">Descrição do Produto</label>
              <input id="desc_pecas" type="text" placeholder="" required /> <!-- Campo automatico - Cadastro de Produtos-->
            </div>
             <div class="col-4">
              <label class="req" for="qtd_pecas">Quantidade</label>
              <input id="qtd_pecas" type="text" placeholder="" required /> <!-- Campo automatico - Cadastro de Produtos-->
            </div>
            <!-- <button id="btnSalvar" type="button">Adicionar Peça</button> Adicionar botão para salvar na lista apenas as peças-->
            <div class="col-4">
              <label for="matricula_prod">Matrícula</label>
              <input id="matricula_prod" type="text" placeholder="" />
            </div>
            <div class="col-4">
              <label for="nome_prod">Nome do Produtivo</label>
              <input id="nome_prod" type="text" placeholder="João Silva" /> <!-- Campo automatico - Cadastro de Funcionários-->
            </div>
            <div class="col-4">
              <label for="qtd_horas">Quantidade de Horas</label>
              <input id="qtd_horas" type="number" min="0" step="0.25" placeholder="3.5" />  <!-- Integrar com o controle de apontamentos, onde identifica a o.s relaciona com a matricula e já traz a quantidade de horas e valor final-->
            </div>
            <div class="col-4">
              <label for="valor_hora">Valor Hora Homem (R$)</label>
              <input id="valor_hora" type="number" min="0" step="0.01" placeholder="85,00" />
            </div>
          </div>
        </section>

        <section class="card">
          <div class="actions">
            <button id="btnSalvar" type="button">Salvar</button>
            <button class="secondary" type="reset" onclick="window.location.reload()">Limpar</button>
            <button class="ghost" type="button" onclick="window.print()">Imprimir</button>
          </div>
          <p class="help">Protótipo estático. Em produção, os dados seriam persistidos em SharePoint/Dataverse/SQL e anexos na respectiva biblioteca.</p>
        </section>
      </main>

      <!-- SUMÁRIO / LADO DIREITO -->
      <aside class="card summary" aria-labelledby="h-sum">
        <h2 id="h-sum">Sumário & Custos</h2>
        <div class="row"><span>Nº O.S</span><span id="s_num_os" class="badge">—</span></div>
        <div class="row"><span>Placa/Prefixo</span><span id="s_placa" class="badge">—</span></div>
        <div class="row"><span>Tipo de Serviço</span><span id="s_tipo" class="badge">—</span></div>
        <hr class="divider"/>
        <div class="row"><span>Horas x Valor</span><span id="s_mo">R$ 0,00</span></div>
        <div class="row"><span>Peças (estim.)</span><span id="s_pecas">R$ 0,00</span></div>
        <div class="row total"><span>Total estimado</span><span id="s_total">R$ 0,00</span></div>
        <p class="help">Obs.: o valor de peças é lido como números dentro do texto (ex.: "R$120").</p>
      </aside>
    </div>
  </div>

<script>
  // Utilidades simples de moeda
  const br = (v)=> v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const parseMoneyInText = (txt)=>{
    if(!txt) return 0;
    const matches = txt.match(/\d+[\.,]?\d*/g) || [];
    return matches.map(n=> parseFloat(n.replace('.', '').replace(',','.')) ).reduce((a,b)=>a+b,0);
  }

  // Preenche sumário
  const num_os = document.getElementById('num_os');
  const placa = document.getElementById('placa');
  const tipo = document.getElementById('tipo_servico');
  const s_num = document.getElementById('s_num_os');
  const s_placa = document.getElementById('s_placa');
  const s_tipo = document.getElementById('s_tipo');
  [num_os, placa, tipo].forEach(el=> el && el.addEventListener('input',()=>{
    s_num.textContent = num_os.value || '—';
    s_placa.textContent = placa.value || '—';
    s_tipo.textContent = tipo.value || '—';
  }));

  // Orçamentos: justificativa e alerta
  const menor = document.getElementById('menor_preco');
  const blkJust = document.getElementById('blk_just');
  const warn = document.getElementById('warn_orc');
  const toggleJust = ()=> blkJust.classList.toggle('hidden', menor.value !== 'nao');
  menor.addEventListener('change', toggleJust); toggleJust();

  // Oficina externa -> DANF mais evidente
  const ofext = document.getElementById('oficina_ext');
  const labDanf = document.getElementById('lab_danf');
  ofext.addEventListener('change', ()=>{
    labDanf.classList.toggle('req', ofext.value==='sim');
  });

  // Cálculo de custos
  const qtdHoras = document.getElementById('qtd_horas');
  const valHora  = document.getElementById('valor_hora');
  const pecasTxt = document.getElementById('pecas');
  const s_mo = document.getElementById('s_mo');
  const s_pc = document.getElementById('s_pecas');
  const s_tot = document.getElementById('s_total');
  function recalc(){
    const h = parseFloat(qtdHoras.value || '0');
    const vh = parseFloat((valHora.value || '0').replace(',','.'));
    const mo = h*vh;
    const pc = parseMoneyInText(pecasTxt.value);
    s_mo.textContent = br(isFinite(mo)?mo:0);
    s_pc.textContent = br(isFinite(pc)?pc:0);
    s_tot.textContent = br((isFinite(mo)?mo:0)+(isFinite(pc)?pc:0));
  }
  [qtdHoras,valHora,pecasTxt].forEach(el=> el && el.addEventListener('input', recalc));
  recalc();

  // Validação de anexos (mínimo 3)
  const filesOk = ()=> ['orc1','orc2','orc3'].every(id => document.getElementById(id).files.length);

  // Salvar (protótipo)
  document.getElementById('btnSalvar').addEventListener('click', ()=>{
    if(!filesOk()){ warn.classList.remove('hidden'); return; }
    warn.classList.add('hidden');
    if(menor.value==='nao' && !document.getElementById('justificativa').value.trim()){
      blkJust.classList.remove('hidden');
      alert('Informe a justificativa para a escolha diferente do menor preço.');
      return;
    }
    alert('Validado! (Protótipo) — Em produção, enviaríamos para API/SharePoint/Dataverse.');
  });
</script>
</body>
</html>
